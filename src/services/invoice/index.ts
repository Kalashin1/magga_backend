import { ObjectId } from "mongodb";
import { AppDataSource } from "../../data-source";
import { Invoice } from "../../entity/invoice";
import draftService, { DraftSerVice } from "../draft";
import notificationService, { NotificationService } from "../notifications";
import userService, { UserService } from "../user";

export class InvoiceService {

  constructor(
    private draftService: DraftSerVice,
    private userService: UserService,
    private notificationService: NotificationService
  ){}


  async create({ draft, external_id, owner, receiver, type = "PROJECT" }: Invoice) {
    console.log("draft", draft);
    const invoiceOwner = await this.userService.getUser({ _id: owner });
    const invoiceReciever = await this.userService.getUser({ _id: receiver });
    const existingDraft = await this.draftService.getDraft(draft);
    if (!invoiceOwner) throw Error("owner of invoice not found");
    if (!invoiceReciever) throw Error("receiver of invoice was not found");
    if (!existingDraft) throw Error("Existing draft not found!");

    const invoice = AppDataSource.mongoManager.create(Invoice, {
      draft,
      external_id,
      owner,
      receiver,
      status: "ACCEPTED",
      type,
    });
    const savedInvoice = await this.save(invoice);

    await this.notificationService.create(
      "New invoice generated",
      "INVOICE",
      owner,
      savedInvoice._id.toString()
    );
    await this.notificationService.create(
      `New invoiced generated by ${invoiceOwner.first_name}`,
      "INVOICE",
      receiver,
      savedInvoice._id.toString()
    );
    await this.draftService.save({...existingDraft, status: "BILLED"});
    console.log('status saved')
    return savedInvoice;
  }

  getOwnerInvoices(owner: string, status?: string) {
    if (status) {
      return AppDataSource.mongoManager.find(Invoice, {
        where: {
          owner: {
            $eq: owner,
          },
          status: {
            $eq: status,
          },
        },
      });
    }
    return AppDataSource.mongoManager.find(Invoice, {
      where: {
        owner: {
          $eq: owner,
        },
      },
    });
  }

  getRecieverInvoices(receiver: string, status?: string) {
    if (status) {
      return AppDataSource.mongoManager.find(Invoice, {
        where: {
          receiver: {
            $eq: receiver,
          },
          status: {
            $eq: status,
          },
        },
      });
    }
    return AppDataSource.mongoManager.find(Invoice, {
      where: {
        receiver: {
          $eq: receiver,
        },
      },
    });
  }

  getInvoiceById(invoice_id: string) {
    return AppDataSource.mongoManager.findOne(Invoice, {
      where: {
        _id: {
          $eq: new ObjectId(invoice_id),
        },
      },
    });
  }

  getInvoiceByExternalId(external_id: string) {
    return AppDataSource.mongoManager.findOne(Invoice, {
      where: {
        external_id: {
          $eq: external_id,
        },
      },
    });
  }

  save(invoice: Invoice) {
    return AppDataSource.mongoManager.save(Invoice, invoice);
  }
}

export default new InvoiceService(
  draftService,
  userService,
  notificationService
)